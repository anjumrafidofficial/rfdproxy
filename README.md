# Update

* 2019-07-24 [v0.1.0](https://github.com/EtherDream/jsproxy/blob/master/changelogs/v0.1.0.md) released, mainly fixes the problem of cache invalidation. The network interface is not compatible with the previous version, please update the server and cfworker in time.

* 2019-06-22 [cfworker Serverless Edition](cf-worker) released, please use this version if you use the demo service for a long time.

[View more](changelogs)


# Installation

```bash
curl https://raw.githubusercontent.com/EtherDream/jsproxy/0.1.0/i.sh | bash
```

* Automatic installation currently only supports Linux x64 and requires root privileges

* Port 80 can be accessed from the Internet during the installation process (apply for HTTPS certificate)

If you cannot meet the above conditions, or want to know the installation details, you can try [Manual Installation](docs/setup.md).

Test: `https://server IP.xip.io:8443` (refer to the script output for details)


### Custom domain name

Resolve the domain name `example.com` to the server IP, and then execute:

```bash
curl https://raw.githubusercontent.com/EtherDream/jsproxy/master/i.sh | bash -s example.com
```

Visit: `https://example.com:8443`


### Custom port

The default ports are 8443 (HTTPS) and 8080 (HTTP). If you need to change to 443 and 80, it is recommended to use port forwarding:

```bash
iptables -A PREROUTING -t nat -p tcp --dport 443 -j REDIRECT --to-ports 8443
iptables -A PREROUTING -t nat -p tcp --dport 80 -j REDIRECT --to-ports 8080
```

Also modify `:8443` in `www.conf` to `:443`.


### Use the GitHub Pages frontend

This project supports front-end and back-end separation, and the front-end part (files in the `www` directory) can be deployed on a third-party web server.

For example, the front end of the demo site is deployed on the GitHub Pages service, so that a personalized domain name (*.github.io) can be used and a certain amount of traffic overhead can be reduced.

Fork this project, enter the `gh-pages` branch (the content of this branch is the same as the `www` directory), and edit the `conf.js` file:

* Node list (`node_map` field, including node id and node host)

* Default node (`node_default` field, specify node id)

Visit `https://username.github.io/jsproxy` to preview.


# Maintenance

```sh
# Switch to jsproxy user
su-jsproxy

# Restart service
./run.sh reload

# Close the service (parameters are the same as nginx -s)
./run.sh quit

# Start service
./run.sh

# View agent log
tail server/nginx/logs/proxy.log
```

At present, it has not yet realized self-starting after booting.


# Prohibit external links

By default, the proxy interface allows all `github.io` subsites to be called, which may cause unnecessary traffic consumption.

If you want to use it only for your own website, you can edit `allowed-sites.conf`. (Restart the service to take effect)


# security strategy

If you do not want the agent to access the intranet (to avoid the risk of SSRF), you can execute `setup-ipset.sh`:

```bash
/home/jsproxy/server/setup-ipset.sh
```

> Need root privileges, rely on the `ipset` command

This script can prohibit `jsporxy` users from accessing the reserved IP segment (for TCP). Programs other than nginx also take effect, but it does not affect other users.


# related articles

* [Based on JS Hook technology to create the most advanced online proxy](https://github.com/EtherDream/jsproxy/blob/master/docs/blogs/js-hook.md)


# Project Features

Compared with traditional online agents, this project has the following characteristics:

## Low server overhead

Traditional online agents almost always replace URLs in resources such as HTML/JS/CSS on the server side. This not only requires a lot of analysis and processing of the content, but also needs to decompress and recompress the traffic, which consumes a lot of CPU resources. And because of the complexity of the logic, it is usually implemented by itself using programming languages ​​such as Python/PHP.

In order to reduce the server overhead, this project uses a black technology of the browser-Service Worker. It allows JS to intercept requests generated by web pages and customize the returned content, which is equivalent to implementing a reverse proxy inside the browser. This allows most of the content processing to be completed on the browser, and the server only needs to forward the traffic purely.

Therefore, the server of this project directly uses nginx, and the content is not modified during the forwarding process (only the HTTP header is modified), which avoids the huge overhead caused by content processing. At the same time, thanks to the rich functions of nginx, many common requirements can be achieved through simple configuration without reinventing the wheel. And both the performance and the stability are far higher than their own realization.

## API virtualization

Traditional online proxies mostly only focus on the replacement of static URLs, ignoring dynamic URLs and URL-related web APIs. For example, a.com reverse proxy google.com, but the page JS reads `document.domain` to get a.com. This may cause some business logic problems.

In order to alleviate this problem, the agent injects a JS into the head of the page to rewrite most of the URL-related APIs so that the JS in the page still gets the original URL:

![](https://raw.githubusercontent.com/EtherDream/jsproxy-localtest/temp/hook.png)

For some APIs that cannot be rewritten, such as `location`, this agent will replace the literal `location` in the code with `__location`, thereby transferring the operation to a custom object. Of course, for non-literal cases (such as `this['lo' +'cation']`), it cannot be handled yet.


# Similar items

All the solutions found so far are traditional back-end replacement URL schemes. Of course, back-end replacement also has many advantages, such as high browser compatibility, and even lower versions of IE can be used.

## zmirror

GitHub: https://github.com/aploium/zmirror

## php-proxy

GitHub: https://github.com/jenssegers/php-proxy


# Project meaning

This project is mainly used for the research of the following technologies:

* Website mirroring / sandboxing

* Phishing website detection technology

* Front-end resource access acceleration

Of course, please do not use this item for illegal purposes, otherwise you will be responsible for the consequences.

Use the Demo page civilly, do not log in and other operations involving privacy.


# License

MIT